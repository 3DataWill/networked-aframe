!function(e){function t(i){if(n[i])return n[i].exports;var o=n[i]={exports:{},id:i,loaded:!1};return e[i].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";n(1),n(19),n(20),n(18)},function(e,t,n){"use strict";var i=n(21),o=n(22),r=n(11),a=n(14),s=n(13),c=n(12),u=n(15),l={};l.app="",l.room="",l.clientId="",l.options=i,l.utils=o,l.log=new r,l.schemas=new a,l.version="0.6.1",l.adapters=new u;var h=new s,d=new c(h);l.connection=d,l.entities=h,e.exports=window.NAF=l},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=n(10),c=function(e){function t(){return i(this,t),o(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),a(t,[{key:"setServerUrl",value:function(e){this.notImplemented("setServerUrl")}},{key:"setApp",value:function(e){this.notImplemented("setApp")}},{key:"setRoom",value:function(e){this.notImplemented("setRoom")}},{key:"setWebRtcOptions",value:function(e){this.notImplemented("setWebRtcOptions")}},{key:"setServerConnectListeners",value:function(e,t){this.notImplemented("setServerConnectListeners")}},{key:"setRoomOccupantListener",value:function(e){this.notImplemented("setRoomOccupantListener")}},{key:"setDataChannelListeners",value:function(e,t,n){this.notImplemented("setDataChannelListeners")}},{key:"connect",value:function(){this.notImplemented("connect")}},{key:"shouldStartConnectionTo",value:function(e){this.notImplemented("shouldStartConnectionTo")}},{key:"startStreamConnection",value:function(e){this.notImplemented("startStreamConnection")}},{key:"closeStreamConnection",value:function(e){this.notImplemented("closeStreamConnection")}},{key:"getConnectStatus",value:function(e){this.notImplemented("getConnectStatus")}},{key:"getMediaStream",value:function(e){return Promise.reject("Interface method not implemented: getMediaStream")}},{key:"getServerTime",value:function(){this.notImplemented("getServerTime")}},{key:"sendData",value:function(e,t,n){this.notImplemented("sendData")}},{key:"sendDataGuaranteed",value:function(e,t,n){this.notImplemented("sendDataGuaranteed")}},{key:"broadcastData",value:function(e,t){this.notImplemented("broadcastData")}},{key:"broadcastDataGuaranteed",value:function(e,t){this.notImplemented("broadcastDataGuaranteed")}},{key:"disconnect",value:function(){this.notImplemented("disconnect")}}]),t}(s);e.exports=c},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=0,r=1,a=0,s=1,c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.15;n(this,e),this.initialized=!1,this.set=!1,this.state=o,this.buffer=[],this.bufferTime=i,this.time=0,this.mark=0,this.lastTime=0,this.mode=t,this.lastPosition=new THREE.Vector3,this.lastVelocity=new THREE.Vector3,this.lastQuaternion=new THREE.Quaternion,this.lastScale=new THREE.Vector3(1,1,1),this.position=new THREE.Vector3,this.quaternion=new THREE.Quaternion,this.scale=new THREE.Vector3(1,1,1)}return i(e,[{key:"hermite",value:function(e,t,n,i,o,r){var a=t*t,s=t*t*t,c=2*s-3*a+1,u=-2*s+3*a,l=s-2*a+t,h=s-a;e.copy(n.multiplyScalar(c)),e.add(i.multiplyScalar(u)),e.add(o.multiplyScalar(l)),e.add(r.multiplyScalar(h))}},{key:"lerp",value:function(e,t,n,i){e.lerpVectors(t,n,i)}},{key:"slerp",value:function(e,t,n,i){THREE.Quaternion.slerp(t,n,e,i)}},{key:"appendBuffer",value:function(e,t,n,i){var o=this.buffer.length-1;this.buffer.length>0&&this.buffer[o].time===this.time?(e&&this.buffer[o].position.copy(e),t&&this.buffer[o].velocity.copy(t),n&&this.buffer[o].quaternion.copy(n),i&&this.buffer[o].scale.copy(i)):(e=e?e.clone():this.buffer.length>0?this.buffer[o].position.clone():this.lastPosition.clone(),t=t?t.clone():this.buffer.length>0?this.buffer[o].velocity.clone():this.lastVelocity.clone(),n=n?n.clone():this.buffer.length>0?this.buffer[o].quaternion.clone():this.lastQuaternion.clone(),i=i?i.clone():this.buffer.length>0?this.buffer[o].scale.clone():this.lastScale.clone(),this.buffer.push({position:e,velocity:t,quaternion:n,scale:i,time:this.time}))}},{key:"isSet",value:function(){return this.set}},{key:"setTarget",value:function(e,t,n,i){this.appendBuffer(e,t,n,i)}},{key:"setPosition",value:function(e,t){this.appendBuffer(e,t,null,null)}},{key:"setQuaternion",value:function(e){this.appendBuffer(null,null,e,null)}},{key:"setScale",value:function(e){this.appendBuffer(null,null,null,e)}},{key:"update",value:function(e){if(this.state===o)this.buffer.length>0&&!this.initialized&&(this.lastPosition.copy(this.buffer[0].position),this.lastVelocity.copy(this.buffer[0].velocity),this.lastQuaternion.copy(this.buffer[0].quaternion),this.lastScale.copy(this.buffer[0].scale),this.lastTime=this.buffer[0].time,this.initialized=!0,this.buffer.shift(),this.position.copy(this.lastPosition),this.quaternion.copy(this.lastQuaternion),this.scale.copy(this.lastScale)),this.buffer.length>0&&this.initialized&&this.time>this.bufferTime&&(this.mark=this.time-1e3*this.bufferTime,this.state=r);else if(this.state==r){for(;this.buffer.length>0&&this.mark>this.buffer[0].time;)this.lastPosition.copy(this.buffer[0].position),this.lastVelocity.copy(this.buffer[0].velocity),this.lastQuaternion.copy(this.buffer[0].quaternion),this.lastScale.copy(this.buffer[0].scale),this.lastTime=this.buffer[0].time,this.buffer.length>1?this.buffer.shift():this.buffer[0].time=this.time+e;if(this.buffer.length>0&&this.buffer[0].time>0){var t=this.buffer[0].time-this.lastTime,n=(this.mark-this.lastTime)/t;this.mode===a?this.lerp(this.position,this.lastPosition,this.buffer[0].position,n):this.mode===s&&this.hermite(this.position,n,this.lastPosition,this.buffer[0].position,this.lastVelocity.multiplyScalar(t),this.buffer[0].velocity.multiplyScalar(t)),this.slerp(this.quaternion,this.lastQuaternion,this.buffer[0].quaternion,n),this.lerp(this.scale,this.lastScale,this.buffer[0].scale,n),this.set=!0}this.mark+=e}this.initialized&&(this.time+=e)}},{key:"getPosition",value:function(){return this.position}},{key:"getQuaternion",value:function(){return this.quaternion}},{key:"getScale",value:function(){return this.scale}}]),e}();"undefined"!=typeof e&&"undefined"!=typeof e.exports&&(e.exports=c)},function(e,t,n){"use strict";function i(e){return null===e||void 0===e}function o(e){return!(!e||"object"!==("undefined"==typeof e?"undefined":a(e))||"number"!=typeof e.length)&&("function"==typeof e.copy&&"function"==typeof e.slice&&!(e.length>0&&"number"!=typeof e[0]))}function r(e,t,n){var r,h;if(i(e)||i(t))return!1;if(e.prototype!==t.prototype)return!1;if(u(e))return!!u(t)&&(e=s.call(e),t=s.call(t),l(e,t,n));if(o(e)){if(!o(t))return!1;if(e.length!==t.length)return!1;for(r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}try{var d=c(e),f=c(t)}catch(e){return!1}if(d.length!=f.length)return!1;for(d.sort(),f.sort(),r=d.length-1;r>=0;r--)if(d[r]!=f[r])return!1;for(r=d.length-1;r>=0;r--)if(h=d[r],!l(e[h],t[h],n))return!1;return("undefined"==typeof e?"undefined":a(e))===("undefined"==typeof t?"undefined":a(t))}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=Array.prototype.slice,c=n(6),u=n(5),l=e.exports=function(e,t,n){return n||(n={}),e===t||(e instanceof Date&&t instanceof Date?e.getTime()===t.getTime():!e||!t||"object"!=("undefined"==typeof e?"undefined":a(e))&&"object"!=("undefined"==typeof t?"undefined":a(t))?n.strict?e===t:e==t:r(e,t,n))}},function(e,t){"use strict";function n(e){return"[object Arguments]"==Object.prototype.toString.call(e)}function i(e){return e&&"object"==("undefined"==typeof e?"undefined":o(e))&&"number"==typeof e.length&&Object.prototype.hasOwnProperty.call(e,"callee")&&!Object.prototype.propertyIsEnumerable.call(e,"callee")||!1}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r="[object Arguments]"==function(){return Object.prototype.toString.call(arguments)}();t=e.exports=r?n:i,t.supported=n,t.unsupported=i},function(e,t){"use strict";function n(e){var t=[];for(var n in e)t.push(n);return t}t=e.exports="function"==typeof Object.keys?Object.keys:n,t.shim=n},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=function(){function e(){n(this,e),this.dict={}}return i(e,[{key:"addChild",value:function(e,t){this.hasParent(e)||(this.dict[e]=[]),this.dict[e].push(t)}},{key:"getChildren",value:function(e){if(!this.hasParent(e))return[];var t=this.dict[e];return delete this.dict[e],t}},{key:"hasParent",value:function(e){return this.dict.hasOwnProperty(e)}}]),e}();e.exports=o},function(e,t,n){"use strict";var i=n(4);e.exports.gatherComponentsData=function(e,t){var n={};for(var i in t){var o=t[i];if("string"==typeof o){var r=e.getAttribute(o);null!==r&&(n[o]=AFRAME.utils.clone(r))}else{var a=NAF.utils.childSchemaToKey(o),s=o.selector?e.querySelector(o.selector):e;if(s){var c=s.getAttribute(o.component);if(null!==c){var u=o.property?c[o.property]:c;n[a]=AFRAME.utils.clone(u)}}}}return n},e.exports.findDirtyComponents=function(e,t,n){var o=[];for(var r in t){var a,s,c=t[r],u="string"==typeof c;if(u){var l=e.getAttribute(c);if(null===l)continue;a=c,s=l}else{var h=c.selector,d=c.component,f=c.property,p=h?e.querySelector(h):e;if(!p)continue;var m=p.getAttribute(d);if(null===m)continue;a=NAF.utils.childSchemaToKey(c),s=m,f&&(s=s[f])}var y=n.hasOwnProperty(a);if(y){var v=n[a];c.requiresNetworkUpdate&&c.requiresNetworkUpdate(v,s)?o.push(c):c.requiresNetworkUpdate||i(v,s)||o.push(c)}else o.push(c)}return o}},function(e,t){"use strict";e.exports.compressSyncData=function(e,t){var n=[];n.push(1),n.push(e.networkId),n.push(e.owner),n.push(e.parent),n.push(e.template);var i=this.compressComponents(e.components,t);return n.push(i),n},e.exports.compressComponents=function(e,t){for(var n={},i=0;i<t.length;i++){var o;o="string"==typeof t[i]?t[i]:NAF.utils.childSchemaToKey(t[i]),e.hasOwnProperty(o)&&(n[i]=e[o])}return n},e.exports.decompressSyncData=function(e,t){var n={};n[0]=0,n.networkId=e[1],n.owner=e[2],n.parent=e[3],n.template=e[4];var i=e[5];return t=this.decompressComponents(i,t),n.components=t,n},e.exports.decompressComponents=function(e,t){var n={};for(var i in e){var o,r=t[i];o="string"==typeof r?r:NAF.utils.childSchemaToKey(r),n[o]=e[i]}return n}},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=function(){function e(){n(this,e)}return i(e,[{key:"notImplemented",value:function(e){NAF.log.error("Interface method not implemented:",e)}}]),e}();e.exports=o},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=function(){function e(){n(this,e),this.debug=!1}return i(e,[{key:"setDebug",value:function(e){this.debug=e}},{key:"write",value:function(){this.debug&&console.log.apply(this,arguments)}},{key:"warn",value:function(){console.warn.apply(this,arguments)}},{key:"error",value:function(){console.error.apply(this,arguments)}}]),e}();e.exports=o},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o={Update:"u",Remove:"r"},r=function(){function e(t){n(this,e),this.entities=t,this.setupDefaultDataSubscriptions(),this.connectedClients={},this.activeDataChannels={}}return i(e,[{key:"setNetworkAdapter",value:function(e){this.adapter=e}},{key:"setupDefaultDataSubscriptions",value:function(){this.dataChannelSubs={},this.dataChannelSubs[o.Update]=this.entities.updateEntity.bind(this.entities),this.dataChannelSubs[o.Remove]=this.entities.removeRemoteEntity.bind(this.entities)}},{key:"connect",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];NAF.app=t,NAF.room=n,this.adapter.setServerUrl(e),this.adapter.setApp(t),this.adapter.setRoom(n);var o={audio:i,video:!1,datachannel:!0};return this.adapter.setWebRtcOptions(o),this.adapter.setServerConnectListeners(this.connectSuccess.bind(this),this.connectFailure.bind(this)),this.adapter.setDataChannelListeners(this.dataChannelOpen.bind(this),this.dataChannelClosed.bind(this),this.receivedData.bind(this)),this.adapter.setRoomOccupantListener(this.occupantsReceived.bind(this)),this.adapter.connect()}},{key:"onConnect",value:function(e){this.onConnectCallback=e,this.isConnected()?e():document.body.addEventListener("connected",e,!1)}},{key:"connectSuccess",value:function(e){NAF.log.write("Networked-Aframe Client ID:",e),NAF.clientId=e;var t=new CustomEvent("connected",{detail:{clientId:e}});document.body.dispatchEvent(t)}},{key:"connectFailure",value:function(e,t){NAF.log.error(e,"failure to connect")}},{key:"occupantsReceived",value:function(e){var t=Object.assign({},this.connectedClients);this.connectedClients=e,this.checkForDisconnectingClients(t,e),this.checkForConnectingClients(e)}},{key:"checkForDisconnectingClients",value:function(e,t){for(var n in e){var i=t.hasOwnProperty(n);i||(NAF.log.write("Closing stream to ",n),this.adapter.closeStreamConnection(n))}}},{key:"checkForConnectingClients",value:function(e){for(var t in e){var n=this.isNewClient(t)&&this.adapter.shouldStartConnectionTo(e[t]);n&&(NAF.log.write("Opening datachannel to ",t),this.adapter.startStreamConnection(t))}}},{key:"getConnectedClients",value:function(){return this.connectedClients}},{key:"isConnected",value:function(){return!!NAF.clientId}},{key:"isMineAndConnected",value:function(e){return this.isConnected()&&NAF.clientId===e}},{key:"isNewClient",value:function(e){return!this.isConnectedTo(e)}},{key:"isConnectedTo",value:function(e){return this.adapter.getConnectStatus(e)===NAF.adapters.IS_CONNECTED}},{key:"dataChannelOpen",value:function(e){NAF.log.write("Opened data channel from "+e),this.activeDataChannels[e]=!0,this.entities.completeSync(e);var t=new CustomEvent("clientConnected",{detail:{clientId:e}});document.body.dispatchEvent(t)}},{key:"dataChannelClosed",value:function(e){NAF.log.write("Closed data channel from "+e),this.activeDataChannels[e]=!1,this.entities.removeEntitiesOfClient(e);var t=new CustomEvent("clientDisconnected",{detail:{clientId:e}});document.body.dispatchEvent(t)}},{key:"hasActiveDataChannel",value:function(e){return this.activeDataChannels.hasOwnProperty(e)&&this.activeDataChannels[e]}},{key:"broadcastData",value:function(e,t){this.adapter.broadcastData(e,t)}},{key:"broadcastDataGuaranteed",value:function(e,t){this.adapter.broadcastDataGuaranteed(e,t)}},{key:"sendData",value:function(e,t,n,i){this.hasActiveDataChannel(e)&&(i?this.adapter.sendDataGuaranteed(e,t,n):this.adapter.sendData(e,t,n))}},{key:"sendDataGuaranteed",value:function(e,t,n){this.sendData(e,t,n,!0)}},{key:"subscribeToDataChannel",value:function(e,t){return this.isReservedDataType(e)?void NAF.log.error("NetworkConnection@subscribeToDataChannel: "+e+" is a reserved dataType. Choose another"):void(this.dataChannelSubs[e]=t)}},{key:"unsubscribeToDataChannel",value:function(e){return this.isReservedDataType(e)?void NAF.log.error("NetworkConnection@unsubscribeToDataChannel: "+e+" is a reserved dataType. Choose another"):void delete this.dataChannelSubs[e]}},{key:"isReservedDataType",value:function(e){return e==o.Update||e==o.Remove}},{key:"receivedData",value:function(e,t,n){this.dataChannelSubs.hasOwnProperty(t)?this.dataChannelSubs[t](e,t,n):NAF.log.error("NetworkConnection@receivedData: "+t+" has not been subscribed to yet. Call subscribeToDataChannel()")}},{key:"getServerTime",value:function(){return this.adapter.getServerTime()}},{key:"disconnect",value:function(){this.entities.removeRemoteEntities(),this.adapter.disconnect(),NAF.app="",NAF.room="",NAF.clientId="",this.connectedClients={},this.activeDataChannels={},this.adapter=null,this.setupDefaultDataSubscriptions(),document.body.removeEventListener("connected",this.onConnectCallback)}}]),e}();e.exports=r},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),r=n(7),a=function(){function e(){i(this,e),this.entities={},this.childCache=new r,this.onRemoteEntityCreatedEvent=new Event("remoteEntityCreated")}return o(e,[{key:"registerEntity",value:function(e,t){this.entities[e]=t}},{key:"createRemoteEntity",value:function(e){NAF.log.write("Creating remote entity",e);var t=e.networkId,n=NAF.schemas.getCachedTemplate(e.template);return n.setAttribute("id","naf-"+t),this.initPosition(n,e.components),this.initRotation(n,e.components),this.addNetworkComponent(n,e),this.registerEntity(t,n),n}},{key:"initPosition",value:function(e,t){var n=t.hasOwnProperty("position");if(n){var i=t.position;e.setAttribute("position",i)}}},{key:"initRotation",value:function(e,t){var n=t.hasOwnProperty("rotation");if(n){var i=t.rotation;e.setAttribute("rotation",i)}}},{key:"addNetworkComponent",value:function(e,t){var n={template:t.template,owner:t.owner,networkId:t.networkId};e.setAttribute("networked",n),e.firstUpdateData=t}},{key:"updateEntity",value:function(e,t,n){var i=1==n[0],o=i?n[1]:n.networkId;this.hasEntity(o)?this.entities[o].emit("networkUpdate",{entityData:n},!1):!i&&this.isFullSync(n)&&this.receiveFirstUpdateFromEntity(n)}},{key:"isFullSync",value:function(e){var t=Object.keys(e.components).length,n=NAF.schemas.getComponents(e.template).length;return t===n}},{key:"receiveFirstUpdateFromEntity",value:function(e){var t=e.parent,n=e.networkId,i=t&&!this.hasEntity(t);if(i)this.childCache.addChild(t,e);else{var o=this.createRemoteEntity(e);this.createAndAppendChildren(n,o),this.addEntityToPage(o,t)}}},{key:"createAndAppendChildren",value:function(e,t){for(var n=this.childCache.getChildren(e),i=0;i<n.length;i++){var o=n[i],r=o.networkId;if(this.hasEntity(r))NAF.log.warn("Tried to instantiate entity multiple times",r,o,"Existing entity:",this.getEntity(r));else{var a=this.createRemoteEntity(o);this.createAndAppendChildren(r,a),t.appendChild(a)}}}},{key:"addEntityToPage",value:function(e,t){this.hasEntity(t)?this.addEntityToParent(e,t):this.addEntityToSceneRoot(e)}},{key:"addEntityToParent",value:function(e,t){var n=document.getElementById("naf-"+t);n.appendChild(e)}},{key:"addEntityToSceneRoot",value:function(e){var t=document.querySelector("a-scene");t.appendChild(e)}},{key:"completeSync",value:function(e){for(var t in this.entities)this.entities.hasOwnProperty(t)&&this.entities[t].emit("syncAll",{targetClientId:e},!1)}},{key:"removeRemoteEntity",value:function(e,t,n){var i=n.networkId;return this.removeEntity(i)}},{key:"removeEntitiesOfClient",value:function(e){var t=[];for(var n in this.entities){var i=NAF.utils.getNetworkOwner(this.entities[n]);if(i==e){var o=this.removeEntity(n);t.push(o)}}return t}},{key:"removeEntity",value:function(e){if(this.hasEntity(e)){var t=this.entities[e];return this.forgetEntity(e),t.parentNode.removeChild(t),t}return NAF.log.error("Tried to remove entity I don't have."),null}},{key:"forgetEntity",value:function(e){delete this.entities[e]}},{key:"getEntity",value:function(e){return this.entities.hasOwnProperty(e)?this.entities[e]:null}},{key:"hasEntity",value:function(e){return this.entities.hasOwnProperty(e)}},{key:"removeRemoteEntities",value:function(){this.childCache=new r;for(var e in this.entities){var t=this.entities[e].getAttribute("networked").owner;t!=NAF.clientId&&this.removeEntity(e)}}}]),e}();e.exports=a},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=function(){function e(){n(this,e),this.schemaDict={},this.templateCache={}}return i(e,[{key:"createDefaultSchema",value:function(e){return{template:e,components:["position","rotation"]}}},{key:"add",value:function(e){if(this.validateSchema(e)){this.schemaDict[e.template]=e;var t=document.querySelector(e.template);if(!t)return void NAF.log.error("Template el not found for "+e.template+", make sure NAF.schemas.add is called after <a-scene> is defined.");if(!this.validateTemplate(e,t))return;this.templateCache[e.template]=document.importNode(t.content,!0)}else NAF.log.error("Schema not valid: ",e),NAF.log.error("See https://github.com/haydenjameslee/networked-aframe#syncing-custom-components")}},{key:"getCachedTemplate",value:function(e){return this.templateIsCached(e)||(this.templateExistsInScene(e)?this.add(this.createDefaultSchema(e)):NAF.log.error("Template el for "+e+" is not in the scene, add the template to <a-assets> and register with NAF.schemas.add.")),this.templateCache[e].firstElementChild.cloneNode(!0)}},{key:"templateIsCached",value:function(e){return this.templateCache.hasOwnProperty(e)}},{key:"getComponents",value:function(e){var t=["position","rotation"];return this.hasTemplate(e)&&(t=this.schemaDict[e].components),t}},{key:"hasTemplate",value:function(e){return this.schemaDict.hasOwnProperty(e)}},{key:"templateExistsInScene",value:function(e){var t=document.querySelector(e);return t&&this.isTemplateTag(t)}},{key:"validateSchema",value:function(e){return e.hasOwnProperty("template")&&e.hasOwnProperty("components")}},{key:"validateTemplate",value:function(e,t){return this.isTemplateTag(t)?!!this.templateHasOneOrZeroChildren(t)||(NAF.log.error("Template for "+e.template+" has more than one child. Templates must have one direct child element, no more. Template found:",t),!1):(NAF.log.error("Template for "+e.template+" is not a <template> tag. Instead found: "+t.tagName),!1)}},{key:"isTemplateTag",value:function(e){return"template"===e.tagName.toLowerCase()}},{key:"templateHasOneOrZeroChildren",value:function(e){return e.content.childElementCount<2}},{key:"remove",value:function(e){delete this.schemaDict[e]}},{key:"clear",value:function(){this.schemaDict={}}}]),e}();e.exports=o},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),r=n(17),a=n(16),s=function(){function e(){i(this,e),this.adapters={wseasyrtc:r,easyrtc:a},this.IS_CONNECTED=e.IS_CONNECTED,this.CONNECTING=e.CONNECTING,this.NOT_CONNECTED=e.NOT_CONNECTED}return o(e,[{key:"register",value:function(e,t){this.adapters[e]=t}},{key:"make",value:function(e){var t=e.toLowerCase();if(this.adapters[t]){var n=this.adapters[t];return new n}throw new Error("Adapter: "+e+" not registered. Please use NAF.adapters.register() to register this adapter.")}}]),e}();s.IS_CONNECTED="IS_CONNECTED",s.CONNECTING="CONNECTING",s.NOT_CONNECTED="NOT_CONNECTED",e.exports=s},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a=function(){function e(e,t){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){o=!0,r=e}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),c=n(2),u=function(e){function t(e){i(this,t);var n=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.easyrtc=e||window.easyrtc,n.app="default",n.room="default",n.audioStreams={},n.pendingAudioRequest={},n.serverTimeRequests=0,n.timeOffsets=[],n.avgTimeOffset=0,n}return r(t,e),s(t,[{key:"setServerUrl",value:function(e){this.easyrtc.setSocketUrl(e)}},{key:"setApp",value:function(e){this.app=e}},{key:"setRoom",value:function(e){this.room=e,this.easyrtc.joinRoom(e,null)}},{key:"setWebRtcOptions",value:function(e){this.easyrtc.enableDataChannels(e.datachannel),this.easyrtc.enableVideo(!1),this.easyrtc.enableAudio(e.audio),this.easyrtc.enableVideoReceive(!1),this.easyrtc.enableAudioReceive(e.audio)}},{key:"setServerConnectListeners",value:function(e,t){this.connectSuccess=e,this.connectFailure=t}},{key:"setRoomOccupantListener",value:function(e){this.easyrtc.setRoomOccupantListener(function(t,n,i){e(n)})}},{key:"setDataChannelListeners",value:function(e,t,n){this.easyrtc.setDataChannelOpenListener(e),this.easyrtc.setDataChannelCloseListener(t),this.easyrtc.setPeerListener(n)}},{key:"updateTimeOffset",value:function(){var e=this,t=Date.now()+this.avgTimeOffset;return fetch(document.location.href,{method:"HEAD",cache:"no-cache"}).then(function(n){var i=1e3,o=new Date(n.headers.get("Date")).getTime()+i/2,r=Date.now(),a=o+(r-t)/2,s=a-r;e.serverTimeRequests++,e.serverTimeRequests<=10?e.timeOffsets.push(s):e.timeOffsets[e.serverTimeRequests%10]=s,e.avgTimeOffset=e.timeOffsets.reduce(function(e,t){return e+=t},0)/e.timeOffsets.length,e.serverTimeRequests>10?setTimeout(function(){return e.updateTimeOffset()},3e5):e.updateTimeOffset()})}},{key:"connect",value:function(){var e=this;Promise.all([this.updateTimeOffset(),new Promise(function(t,n){e.easyrtc.audioEnabled?e._connectWithAudio(t,n):e.easyrtc.connect(e.app,t,n)})]).then(function(t){var n=a(t,2),i=(n[0],n[1]);e._storeAudioStream(e.easyrtc.myEasyrtcid,e.easyrtc.getLocalStream()),e._myRoomJoinTime=e._getRoomJoinTime(i),e.connectSuccess(i)}).catch(this.connectFailure)}},{key:"shouldStartConnectionTo",value:function(e){return this._myRoomJoinTime<=e.roomJoinTime}},{key:"startStreamConnection",value:function(e){this.easyrtc.call(e,function(e,t){"datachannel"===t&&NAF.log.write("Successfully started datachannel to ",e)},function(e,t){NAF.log.error(e,t)},function(e){})}},{key:"closeStreamConnection",value:function(e){}},{key:"sendData",value:function(e,t,n){this.easyrtc.sendData(e,t,n)}},{key:"sendDataGuaranteed",value:function(e,t,n){this.easyrtc.sendDataWS(e,t,n)}},{key:"broadcastData",value:function(e,t){var n=this.easyrtc.getRoomOccupantsAsMap(this.room);for(var i in n)n.hasOwnProperty(i)&&i!==this.easyrtc.myEasyrtcid&&this.easyrtc.sendData(i,e,t)}},{key:"broadcastDataGuaranteed",value:function(e,t){var n={targetRoom:this.room};this.easyrtc.sendDataWS(n,e,t)}},{key:"getConnectStatus",value:function(e){var t=this.easyrtc.getConnectStatus(e);return t==this.easyrtc.IS_CONNECTED?NAF.adapters.IS_CONNECTED:t==this.easyrtc.NOT_CONNECTED?NAF.adapters.NOT_CONNECTED:NAF.adapters.CONNECTING}},{key:"getMediaStream",value:function(e){var t=this;return this.audioStreams[e]?(NAF.log.write("Already had audio for "+e),Promise.resolve(this.audioStreams[e])):(NAF.log.write("Waiting on audio for "+e),new Promise(function(n){t.pendingAudioRequest[e]=n}))}},{key:"disconnect",value:function(){this.easyrtc.disconnect()}},{key:"_storeAudioStream",value:function(e,t){this.audioStreams[e]=t,this.pendingAudioRequest[e]&&(NAF.log.write("got pending audio for "+e),this.pendingAudioRequest[e](t),delete this.pendingAudioRequest[e](t))}},{key:"_connectWithAudio",value:function(e,t){var n=this;this.easyrtc.setStreamAcceptor(this._storeAudioStream.bind(this)),this.easyrtc.setOnStreamClosed(function(e){delete n.audioStreams[e]}),this.easyrtc.initMediaSource(function(){n.easyrtc.connect(n.app,e,t)},function(e,t){NAF.log.error(e,t)})}},{key:"_getRoomJoinTime",value:function(e){var t=NAF.room,n=this.easyrtc.getRoomOccupantsAsMap(t)[e].roomJoinTime;return n}},{key:"getServerTime",value:function(){return Date.now()+this.avgTimeOffset}}]),t}(c);e.exports=u},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a=function(){function e(e,t){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){o=!0,r=e}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,
i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),c=n(2),u=function(e){function t(e){i(this,t);var n=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.easyrtc=e||window.easyrtc,n.app="default",n.room="default",n.connectedClients=[],n.serverTimeRequests=0,n.timeOffsets=[],n.avgTimeOffset=0,n}return r(t,e),s(t,[{key:"setServerUrl",value:function(e){this.serverUrl=e,this.easyrtc.setSocketUrl(e)}},{key:"setApp",value:function(e){this.app=e}},{key:"setRoom",value:function(e){this.room=e,this.easyrtc.joinRoom(e,null)}},{key:"setWebRtcOptions",value:function(e){}},{key:"setServerConnectListeners",value:function(e,t){this.connectSuccess=e,this.connectFailure=t}},{key:"setRoomOccupantListener",value:function(e){this.easyrtc.setRoomOccupantListener(function(t,n,i){e(n)})}},{key:"setDataChannelListeners",value:function(e,t,n){this.openListener=e,this.closedListener=t,this.easyrtc.setPeerListener(n)}},{key:"updateTimeOffset",value:function(){var e=this,t=Date.now()+this.avgTimeOffset;return fetch(document.location.href,{method:"HEAD",cache:"no-cache"}).then(function(n){var i=1e3,o=new Date(n.headers.get("Date")).getTime()+i/2,r=Date.now(),a=o+(r-t)/2,s=a-r;e.serverTimeRequests++,e.serverTimeRequests<=10?e.timeOffsets.push(s):e.timeOffsets[e.serverTimeRequests%10]=s,e.avgTimeOffset=e.timeOffsets.reduce(function(e,t){return e+=t},0)/e.timeOffsets.length,e.serverTimeRequests>10?setTimeout(function(){return e.updateTimeOffset()},3e5):e.updateTimeOffset()})}},{key:"connect",value:function(){var e=this;Promise.all([this.updateTimeOffset(),new Promise(function(t,n){e.easyrtc.connect(e.app,t,n)})]).then(function(t){var n=a(t,2),i=(n[0],n[1]);e.connectSuccess(i)}).catch(this.connectFailure)}},{key:"shouldStartConnectionTo",value:function(e){return!0}},{key:"startStreamConnection",value:function(e){this.connectedClients.push(e),this.openListener(e)}},{key:"closeStreamConnection",value:function(e){var t=this.connectedClients.indexOf(e);t>-1&&this.connectedClients.splice(t,1),this.closedListener(e)}},{key:"sendData",value:function(e,t,n){this.easyrtc.sendDataWS(e,t,n)}},{key:"sendDataGuaranteed",value:function(e,t,n){this.sendData(e,t,n)}},{key:"broadcastData",value:function(e,t){var n={targetRoom:this.room};this.easyrtc.sendDataWS(n,e,t)}},{key:"broadcastDataGuaranteed",value:function(e,t){this.broadcastData(e,t)}},{key:"getConnectStatus",value:function(e){var t=this.connectedClients.indexOf(e)!=-1;return t?NAF.adapters.IS_CONNECTED:NAF.adapters.NOT_CONNECTED}},{key:"getServerTime",value:function(){return Date.now()+this.avgTimeOffset}},{key:"disconnect",value:function(){this.easyrtc.disconnect()}}]),t}(c);e.exports=u},function(e,t,n){"use strict";var i=n(1);AFRAME.registerComponent("networked-audio-source",{schema:{positional:{default:!0},distanceModel:{default:"inverse",oneOf:["linear","inverse","exponential"]},maxDistance:{default:1e4},refDistance:{default:1},rolloffFactor:{default:1}},init:function(){var e=this;this.listener=null,this.stream=null,this._setMediaStream=this._setMediaStream.bind(this),NAF.utils.getNetworkedEntity(this.el).then(function(t){var n=t.components.networked.data.owner;n&&NAF.connection.adapter.getMediaStream(n).then(e._setMediaStream).catch(function(e){return i.log.error("Error getting media stream for "+n,e)})})},update:function(){this._setPannerProperties()},_setMediaStream:function(e){if(this.sound||this.setupSound(),e!=this.stream){if(this.stream&&this.sound.disconnect(),e){/chrome/i.test(navigator.userAgent)&&(this.audioEl=new Audio,this.audioEl.setAttribute("autoplay","autoplay"),this.audioEl.setAttribute("playsinline","playsinline"),this.audioEl.srcObject=e,this.audioEl.volume=0);var t=this.sound.context.createMediaStreamSource(e);this.sound.setNodeSource(t),this.el.emit("sound-source-set",{soundSource:t})}this.stream=e}},_setPannerProperties:function(){this.sound&&this.data.positional&&(this.sound.setDistanceModel(this.data.distanceModel),this.sound.setMaxDistance(this.data.maxDistance),this.sound.setRefDistance(this.data.refDistance),this.sound.setRolloffFactor(this.data.rolloffFactor))},remove:function(){this.sound&&(this.el.removeObject3D(this.attrName),this.stream&&this.sound.disconnect())},setupSound:function(){var e=this.el,t=e.sceneEl;this.sound&&e.removeObject3D(this.attrName),t.audioListener||(t.audioListener=new THREE.AudioListener,t.camera&&t.camera.add(t.audioListener),t.addEventListener("camera-set-active",function(e){e.detail.cameraEl.getObject3D("camera").add(t.audioListener)})),this.listener=t.audioListener,this.sound=this.data.positional?new THREE.PositionalAudio(this.listener):new THREE.Audio(this.listener),e.setObject3D(this.attrName,this.sound),this._setPannerProperties()}})},function(e,t){"use strict";AFRAME.registerComponent("networked-scene",{schema:{serverURL:{default:"/"},app:{default:"default"},room:{default:"default"},connectOnLoad:{default:!0},onConnect:{default:"onConnect"},adapter:{default:"wsEasyRtc"},audio:{default:!1},debug:{default:!1}},init:function(){var e=this.el;this.connect=this.connect.bind(this),e.addEventListener("connect",this.connect),this.data.connectOnLoad&&e.emit("connect",null,!1)},connect:function(){return NAF.log.setDebug(this.data.debug),NAF.log.write("Networked-Aframe Connecting..."),this.checkDeprecatedProperties(),this.setupNetworkAdapter(),this.hasOnConnectFunction()&&this.callOnConnect(),NAF.connection.connect(this.data.serverURL,this.data.app,this.data.room,this.data.audio)},checkDeprecatedProperties:function(){},setupNetworkAdapter:function(){var e=this.data.adapter,t=NAF.adapters.make(e);NAF.connection.setNetworkAdapter(t)},hasOnConnectFunction:function(){return""!=this.data.onConnect&&window.hasOwnProperty(this.data.onConnect)},callOnConnect:function(){NAF.connection.onConnect(window[this.data.onConnect])},remove:function(){NAF.log.write("networked-scene disconnected"),this.el.removeEventListener("connect",this.connect),NAF.connection.disconnect()}})},function(e,t,n){"use strict";var i=n(8),o=n(9),r=n(3),a=THREE.Math.DEG2RAD;AFRAME.registerComponent("networked",{schema:{template:{default:""},attachTemplateToLocal:{default:!0},networkId:{default:""},owner:{default:""}},init:function(){this.OWNERSHIP_GAINED="ownership-gained",this.OWNERSHIP_CHANGED="ownership-changed",this.OWNERSHIP_LOST="ownership-lost",this.conversionEuler=new THREE.Euler,this.conversionEuler.order="YXZ",this.interpolationBuffers=[];var e=this.wasCreatedByNetwork();this.onConnected=this.onConnected.bind(this),this.onSyncAll=this.onSyncAll.bind(this),this.syncDirty=this.syncDirty.bind(this),this.networkUpdateHandler=this.networkUpdateHandler.bind(this),this.cachedData={},this.initNetworkParent(),""===this.data.networkId&&this.el.setAttribute(this.name,{networkId:NAF.utils.createNetworkId()}),e?this.firstUpdate():(this.data.attachTemplateToLocal&&this.attachTemplateToLocal(),this.registerEntity(this.data.networkId)),this.lastOwnerTime=-1,NAF.clientId?this.onConnected():document.body.addEventListener("connected",this.onConnected,!1),document.body.dispatchEvent(this.entityCreatedEvent()),this.el.dispatchEvent(new CustomEvent("instantiated",{detail:{el:this.el}}))},attachTemplateToLocal:function(){for(var e=NAF.schemas.getCachedTemplate(this.data.template),t=e.attributes,n=0;n<t.length;n++)this.el.setAttribute(t[n].name,t[n].value);for(;e.firstElementChild;)this.el.appendChild(e.firstElementChild)},takeOwnership:function(){var e=this.data.owner,t=this.lastOwnerTime,n=NAF.connection.getServerTime();return!!(e&&!this.isMine()&&t<n)&&(this.lastOwnerTime=n,this.removeLerp(),this.el.setAttribute("networked",{owner:NAF.clientId}),this.syncAll(),this.el.emit(this.OWNERSHIP_GAINED,{el:this.el,oldOwner:e}),this.el.emit(this.OWNERSHIP_CHANGED,{el:this.el,oldOwner:e,newOwner:NAF.clientId}),!0)},wasCreatedByNetwork:function(){return!!this.el.firstUpdateData},initNetworkParent:function(){var e=this.el.parentElement;e.hasOwnProperty("components")&&e.components.hasOwnProperty("networked")?this.parent=e:this.parent=null},registerEntity:function(e){NAF.entities.registerEntity(e,this.el)},firstUpdate:function(){var e=this.el.firstUpdateData;this.networkUpdate(e)},onConnected:function(){var e=this;""===this.data.owner&&(this.lastOwnerTime=NAF.connection.getServerTime(),this.el.setAttribute(this.name,{owner:NAF.clientId}),setTimeout(function(){return e.el.parentNode?void e.syncAll():void NAF.log.warn("Networked element was removed before ever getting the chance to syncAll")},0)),document.body.removeEventListener("connected",this.onConnected,!1)},isMine:function(){return this.data.owner===NAF.clientId},play:function(){this.bindEvents()},bindEvents:function(){var e=this.el;e.addEventListener("sync",this.syncDirty),e.addEventListener("syncAll",this.onSyncAll),e.addEventListener("networkUpdate",this.networkUpdateHandler)},pause:function(){this.unbindEvents()},unbindEvents:function(){var e=this.el;e.removeEventListener("sync",this.syncDirty),e.removeEventListener("syncAll",this.onSyncAll),e.removeEventListener("networkUpdate",this.networkUpdateHandler)},tick:function(e,t){if(this.isMine()&&this.needsToSync()){if(!this.el.parentElement)return void NAF.log.error("tick called on an entity that seems to have been removed");this.syncDirty()}if(NAF.options.useLerp&&!this.isMine())for(var n=0;n<this.interpolationBuffers.length;n++){var i=this.interpolationBuffers[n].buffer,o=this.interpolationBuffers[n].el;i.update(t),o.object3D.position.copy(i.getPosition()),o.object3D.quaternion.copy(i.getQuaternion()),o.object3D.scale.copy(i.getScale())}},onSyncAll:function(e){var t=e.detail.targetClientId;this.syncAll(t)},syncAll:function(e){if(this.canSync()){this.updateNextSyncTime();var t=this.getAllSyncedComponents(),n=i.gatherComponentsData(this.el,t),o=this.createSyncData(n);e?NAF.connection.sendDataGuaranteed(e,"u",o):NAF.connection.broadcastDataGuaranteed("u",o),this.updateCache(n)}},syncDirty:function(){if(this.canSync()){this.updateNextSyncTime();var e=this.getAllSyncedComponents(),t=i.findDirtyComponents(this.el,e,this.cachedData);if(0!=t.length){var n=i.gatherComponentsData(this.el,t),r=this.createSyncData(n);NAF.options.compressSyncPackets&&(r=o.compressSyncData(r,e)),NAF.connection.broadcastData("u",r),this.updateCache(n)}}},canSync:function(){return this.data.owner&&this.isMine()},needsToSync:function(){return NAF.utils.now()>=this.nextSyncTime},updateNextSyncTime:function(){this.nextSyncTime=NAF.utils.now()+1e3/NAF.options.updateRate},createSyncData:function(e){var t=this.data,n={0:0,networkId:t.networkId,owner:t.owner,lastOwnerTime:this.lastOwnerTime,template:t.template,parent:this.getParentId(),components:e};return n},getParentId:function(){if(this.initNetworkParent(),!this.parent)return null;var e=this.parent.getAttribute("networked");return e.networkId},getAllSyncedComponents:function(){return NAF.schemas.getComponents(this.data.template)},updateCache:function(e){for(var t in e)this.cachedData[t]=e[t]},networkUpdateHandler:function(e){var t=e.detail.entityData;this.networkUpdate(t)},networkUpdate:function(e){if(1==e[0]&&(e=o.decompressSyncData(e,this.getAllSyncedComponents())),!(e.lastOwnerTime<this.lastOwnerTime||this.lastOwnerTime===e.lastOwnerTime&&this.data.owner>e.owner)){if(this.data.owner!==e.owner){var t=this.isMine();this.lastOwnerTime=e.lastOwnerTime;var n=this.data.owner,i=e.owner;t&&this.el.emit(this.OWNERSHIP_LOST,{el:this.el,newOwner:i}),this.el.emit(this.OWNERSHIP_CHANGED,{el:this.el,oldOwner:n,newOwner:i}),this.el.setAttribute("networked",{owner:e.owner})}this.updateComponents(e.components)}},updateComponents:function(e){var t=this.el;NAF.schemas.getComponents(this.data.template);for(var n in e)if(this.isSyncableComponent(n)){var i=e[n];if(NAF.utils.isChildSchemaKey(n)){var o=NAF.utils.keyToChildSchema(n),r=o.selector?t.querySelector(o.selector):t;r&&(o.property?r.setAttribute(o.component,o.property,i):this.updateComponent(r,o.component,i))}else this.updateComponent(t,n,i)}},updateComponent:function(e,t,n){if(!NAF.options.useLerp)return void e.setAttribute(t,n);var i=null,o=this.interpolationBuffers.find(function(t){return t.el===e});switch(o?i=this.interpolationBuffers.find(function(t){return t.el===e}).buffer:(i=new r,this.interpolationBuffers.push({buffer:i,el:e})),t){case"position":i.setPosition(new THREE.Vector3(n.x,n.y,n.z));break;case"rotation":this.conversionEuler.set(a*n.x,a*n.y,a*n.z),i.setQuaternion((new THREE.Quaternion).setFromEuler(this.conversionEuler));break;case"scale":i.setScale(new THREE.Vector3(n.x,n.y,n.z));break;default:e.setAttribute(t,n)}},removeLerp:function(){this.interpolationBuffers=[]},isSyncableComponent:function(e){if(NAF.utils.isChildSchemaKey(e)){var t=NAF.utils.keyToChildSchema(e);return this.hasThisChildSchema(t)}return this.getAllSyncedComponents().indexOf(e)!=-1},hasThisChildSchema:function(e){var t=this.getAllSyncedComponents();for(var n in t){var i=t[n];if(NAF.utils.childSchemaEqual(i,e))return!0}return!1},remove:function(){if(this.isMine()&&NAF.connection.isConnected()){var e={networkId:this.data.networkId};NAF.entities.hasEntity(this.data.networkId)?(NAF.connection.broadcastDataGuaranteed("r",e),NAF.entities.forgetEntity(this.data.networkId)):NAF.log.error("Removing networked entity that is not in entities array.")}document.body.dispatchEvent(this.entityRemovedEvent(this.data.networkId))},entityCreatedEvent:function(){return new CustomEvent("entityCreated",{detail:{el:this.el}})},entityRemovedEvent:function(e){return new CustomEvent("entityRemoved",{detail:{networkId:e}})}})},function(e,t){"use strict";var n={debug:!1,updateRate:15,compressSyncPackets:!1,useLerp:!0};e.exports=n},function(e,t){"use strict";function n(e){return new Promise(function(t,n){for(var i=e;i&&!i.hasAttribute("networked");)i=i.parentNode;return i?void(i.hasLoaded?t(i):i.addEventListener("instantiated",function(){t(i)},{once:!0})):n("Entity does not have and is not a child of an entity with the [networked] component ")})}e.exports.whenEntityLoaded=function(e,t){e.hasLoaded&&t(),e.addEventListener("loaded",function(){t()})},e.exports.createHtmlNodeFromString=function(e){var t=document.createElement("div");t.innerHTML=e;var n=t.firstChild;return n},e.exports.getNetworkOwner=function(e){var t=e.components;return t.hasOwnProperty("networked")?t.networked.data.owner:null},e.exports.getNetworkId=function(e){var t=e.components;return t.hasOwnProperty("networked")?t.networked.data.networkId:null},e.exports.now=function(){return Date.now()},e.exports.createNetworkId=function(){return Math.random().toString(36).substring(2,9)},e.exports.delimiter="---",e.exports.childSchemaToKey=function(t){var n=(t.selector||"")+e.exports.delimiter+(t.component||"")+e.exports.delimiter+(t.property||"");return n},e.exports.keyToChildSchema=function(t){var n=t.split(e.exports.delimiter,3);return{selector:n[0]||void 0,component:n[1],property:n[2]||void 0}},e.exports.isChildSchemaKey=function(t){return t.indexOf(e.exports.delimiter)!=-1},e.exports.childSchemaEqual=function(e,t){return e.selector==t.selector&&e.component==t.component&&e.property==t.property},e.exports.getNetworkedEntity=n,e.exports.takeOwnership=function(e){for(var t=e;t&&!t.hasAttribute("networked");)t=t.parentNode;if(t){if(!t.components.networked)throw new Error("Entity with [networked] component not initialized.");return t.components.networked.takeOwnership()}throw new Error("takeOwnership() must be called on an entity or child of an entity with the [networked] component.")},e.exports.isMine=function(e){for(var t=e;t&&!t.hasAttribute("networked");)t=t.parentNode;if(t){if(!t.components.networked)throw new Error("Entity with [networked] component not initialized.");return t.components.networked.data.owner===NAF.clientId}throw new Error("isMine() must be called on an entity or child of an entity with the [networked] component.")},e.exports.almostEqualVec3=function(e,t,n){return Math.abs(e.x-t.x)<n&&Math.abs(e.y-t.y)<n&&Math.abs(e.z-t.z)<n}}]);